<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
      integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Nunito:400,600|Open+Sans:400,600,700"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/easion.css" />
    <title>Library - Categories</title>
  </head>

  <body>
    <div class="dash">
      <div class="dash-nav dash-nav-dark">
        <header>
          <a href="#!" class="menu-toggle">
            <i class="fas fa-bars"></i>
          </a>
          <a href="index.html" class="easion-logo"><span>Library</span></a>
        </header>
        <nav class="dash-nav-list">
          <a href="index.html" class="dash-nav-item">
            <i class="fas fa-home"></i> Dashboard
          </a>
          <a href="book.html" class="dash-nav-item">
            <i class="fas fa-book"></i> Books
          </a>
          <a href="category.html" class="dash-nav-item">
            <i class="fas fa-list"></i> Categories
          </a>
        </nav>
      </div>
      <div class="dash-app">
        <header class="dash-toolbar">
          <a href="#!" class="menu-toggle">
            <i class="fas fa-bars"></i>
          </a>
          <div class="tools">
            <div class="dropdown tools-item">
              <a
                href="#"
                class=""
                id="dropdownMenu1"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <i class="fas fa-user"></i>
              </a>
              <div
                class="dropdown-menu dropdown-menu-right"
                aria-labelledby="dropdownMenu1"
              >
                <a class="dropdown-item" href="profile.html">Profile</a>
                <a class="dropdown-item" href="#!" id="logout-btn">Logout</a>
              </div>
            </div>
          </div>
        </header>
        <main class="dash-content">
          <div class="container-fluid">
            <h1 class="dash-title">Categories</h1>
            <div class="row">
              <div class="col-lg-12">
                <div class="card easion-card">
                  <div class="card-header">
                    <div class="easion-card-icon">
                      <i class="fas fa-list"></i>
                    </div>
                    <div class="easion-card-title">All Categories</div>
                    <div class="easion-card-menu">
                      <button
                        class="btn btn-primary btn-sm"
                        data-toggle="modal"
                        data-target="#categoryModal"
                        onclick="openAddCategoryModal()"
                      >
                        <i class="fas fa-plus"></i> Add Category
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <table class="table table-striped table-in-card">
                      <thead>
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col">Name</th>
                          <th scope="col">Description</th>
                          <th scope="col">Color</th>
                          <th scope="col">Books</th>
                          <th scope="col">Status</th>
                          <th scope="col">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="categories-table-body">
                        <tr>
                          <td colspan="7" class="text-center">
                            Loading categories...
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div
      class="modal fade"
      id="categoryModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="categoryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="categoryModalLabel">Add Category</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="category-form">
            <div class="modal-body">
              <input type="hidden" id="category-id" />
              <div class="form-group">
                <label for="category-name">Category Name *</label>
                <input
                  type="text"
                  class="form-control"
                  id="category-name"
                  required
                  maxlength="100"
                />
              </div>
              <div class="form-group">
                <label for="category-description">Description</label>
                <textarea
                  class="form-control"
                  id="category-description"
                  rows="3"
                  maxlength="500"
                ></textarea>
              </div>
              <div class="form-group">
                <label for="category-color">Color</label>
                <input
                  type="color"
                  class="form-control"
                  id="category-color"
                  value="#6c757d"
                />
              </div>
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input
                    type="checkbox"
                    class="custom-control-input"
                    id="category-active"
                    checked
                  />
                  <label class="custom-control-label" for="category-active"
                    >Active</label
                  >
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save Category
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script src="../js/easion.js"></script>
    <script src="../js/auth.js"></script>

    <script>
      // Check authentication
      window.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }
        loadCategories();
      });

      // Load all categories
      async function loadCategories() {
        try {
          const response = await categoryAPI.getAll();
          const tbody = document.getElementById("categories-table-body");

          if (!response.success || response.categories.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="7" class="text-center">No categories found. Click "Add Category" to create one.</td></tr>';
            return;
          }

          tbody.innerHTML = response.categories
            .map(
              (cat, index) => `
                    <tr>
                        <th scope="row">${index + 1}</th>
                        <td>${cat.name}</td>
                        <td>${cat.description || "-"}</td>
                        <td>
                            <span class="badge" style="background-color: ${cat.color}; color: white; padding: 5px 10px; border-radius: 3px;">
                                ${cat.color}
                            </span>
                        </td>
                        <td>${cat.bookCount || 0}</td>
                        <td>
                            <span class="badge badge-${cat.isActive ? "success" : "secondary"}">
                                ${cat.isActive ? "Active" : "Inactive"}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editCategory('${cat._id}')" data-toggle="modal" data-target="#categoryModal">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat._id}', '${cat.name}', ${cat.bookCount || 0})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `,
            )
            .join("");
        } catch (error) {
          console.error("Error loading categories:", error);
          document.getElementById("categories-table-body").innerHTML =
            `<tr><td colspan="7" class="text-center text-danger">Error loading categories: ${error.message}</td></tr>`;
        }
      }

      // Open modal for adding category
      function openAddCategoryModal() {
        document.getElementById("categoryModalLabel").textContent =
          "Add Category";
        document.getElementById("category-form").reset();
        document.getElementById("category-id").value = "";
        document.getElementById("category-color").value = "#6c757d";
        document.getElementById("category-active").checked = true;
      }

      // Edit category
      async function editCategory(categoryId) {
        try {
          const response = await categoryAPI.getAll();
          const category = response.categories.find(
            (c) => c._id === categoryId,
          );

          if (category) {
            document.getElementById("categoryModalLabel").textContent =
              "Edit Category";
            document.getElementById("category-id").value = category._id;
            document.getElementById("category-name").value = category.name;
            document.getElementById("category-description").value =
              category.description || "";
            document.getElementById("category-color").value =
              category.color || "#6c757d";
            document.getElementById("category-active").checked =
              category.isActive !== false;
          }
        } catch (error) {
          alert("Error loading category: " + error.message);
        }
      }

      // Delete category
      async function deleteCategory(categoryId, categoryName, bookCount) {
        if (bookCount > 0) {
          alert(
            `Cannot delete "${categoryName}". It contains ${bookCount} books. Please move or delete these books first.`,
          );
          return;
        }

        if (!confirm(`Are you sure you want to delete "${categoryName}"?`)) {
          return;
        }

        try {
          await categoryAPI.delete(categoryId);
          alert("Category deleted successfully!");
          loadCategories();
        } catch (error) {
          alert("Error deleting category: " + error.message);
        }
      }

      // Handle form submission
      document
        .getElementById("category-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const categoryId = document.getElementById("category-id").value;
          const categoryData = {
            name: document.getElementById("category-name").value,
            description: document.getElementById("category-description").value,
            color: document.getElementById("category-color").value,
            isActive: document.getElementById("category-active").checked,
          };

          try {
            if (categoryId) {
              await categoryAPI.update(categoryId, categoryData);
              alert("Category updated successfully!");
            } else {
              await categoryAPI.create(categoryData);
              alert("Category created successfully!");
            }

            $("#categoryModal").modal("hide");
            loadCategories();
          } catch (error) {
            alert("Error saving category: " + error.message);
          }
        });

      // Logout functionality
      document.getElementById("logout-btn").addEventListener("click", logout);
    </script>
  </body>
</html>
